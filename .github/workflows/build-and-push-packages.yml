name: Build and push packages 📦
run-name: ${{ github.actor }} is building package with GitHub Actions 🚀
on:
  push:
    branches: ['main']
    paths: ['nodes/**']
jobs:
  Create-Packages:
    name: Create packages and upload to S3
    runs-on: ubuntu-latest
    steps:
      # - name: Install AWS CLI
      #   id: install-aws-cli
      #   uses: unfor19/install-aws-cli-action@master
      #   with:
      #     version: 2

      # https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions

      - name: Get changed files in the docs folder
        id: changed-script-files
        uses: tj-actions/changed-files@v39
        with:
          files: nodes/**/*.{sh,shell}  # Alternatively using: `docs/**` or `docs`
          files_ignore: "*.md" # Ignore all markdown files
          # since_last_remote_commit: true

      - name: Run step if any script file(s) has changed
        if: steps.changed-script-files.outputs.any_changed == 'true'
        run: |
          echo "One or more script file has changed."
          nodes_list=()
          for file in ${{ steps.changed-script-files.outputs.all_changed_files }}; do
            echo "$file was changed"
            foldername=$(dirname "$file")
            node_name=$(basename $foldername)
            nodes_list+=($node_name)
          done

          echo "💻 Nodes list: $nodes_list"
          unique_nodes_list=($(echo "${nodes_list[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

          for node_name in "${unique_nodes_list[@]}"; do
            foldername="nodes/$node_name"

            echo "🕦📦 Creating package.zip for $node_name node with 🗂️ $foldername folder"
            zip -r package.zip $foldername
            echo "✅📦 Created package.zip"

            echo "🕦🪣 Uploading package.zip to s3 bucket"
            echo "aws s3 cp package.zip s3://$S3_BUCKET_NAME/$node_name/${GITHUB_SHA::7}/package.zip"
            echo "✅🪣 Uploaded package.zip to s3 bucket"

            rm package.zip
          done

      - run: echo "🍏 This job's status is ${{ job.status }}."
