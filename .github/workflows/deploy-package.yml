name: Deploy Package ðŸ“¦
run-name: ${{ github.actor }} is deploying packages with GitHub Actions ðŸš€

on: 
  workflow_dispatch:
    inputs:
      node-list:
        description: 'Node list on which you want to deploy the package'     
        required: true
        # default: ''
      tags:
        description: 'Version tag you want to deploy'
        required: true
        # default: 'latest'
env:
  S3_BUCKET_NAME: dollaru-script

jobs: 
  deploy-specified-package-on-node:
    name: Deploy packages version ${{ inputs.tags }} on ${{ inputs.node-list }}
    runs-on: ubuntu-latest
    steps:
      - name:  Download package.tar.gz from S3
        run: |
          my_string=${{ inputs.node-list }}
          my_string_without_spaces="{{ my_string.replace(' ', '') }}"
          my_nodes_list=[{{ my_string_without_spaces.split(',') | map('quote') | join(',') }}]
          
          echo "ðŸ’» Nodes list: $my_nodes_list"

          for node_name in "${my_nodes_list[@]}"; do
            echo "ðŸ•¦ðŸ“¦ Downloading package.tar.gz from S3"
            echo "aws s3 cp s3://dollaru-script/${node_name}/${{ inputs.tags }}/package.tar.gz package.tar.gz"
            echo "âœ…ðŸ“¦ Downloaded package.tar.gz from S3"

            echo "ðŸ•¦ðŸš¢ Shipping package to node"
            echo "ssh ubuntu@${node_name} \"rm -rf /target/dir-backup && cp /target/dir /target/dir-backup && rm -rf /target/dir \""
            echo "ssh ubuntu@${node_name} \"cd /target/dir && tar -xvv\" < package.tar.gz"
            echo "âœ…ðŸš¢ Shipping package to node"

            rm package.tar.gz
          done;
